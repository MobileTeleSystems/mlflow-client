version: "3.5"
services:
  mlflow-client-test-integration:
    image: docker.rep.msk.mts.ru/bigdata/platform/dsx/mlflow-client:${TAG:-test-integration}
    env_file: .env.test.integration
    environment:
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-}
    build:
      context: .
      dockerfile: Dockerfile.integration
    volumes:
      - ./mlflow_client:/app/mlflow_client:ro
      - ./tests/integration:/app/tests/integration:ro
      - ./integration-tests.sh:/app/integration-tests.sh:ro
    depends_on:
        - "mlflow-test"
    networks:
      - default
      - mlflow
  mlflow-test:
    image: docker.rep.msk.mts.ru/bigdata/platform/dsx/mlflow:${MLFLOW_TAG:-latest}
    env_file: .env.test.integration
    environment:
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-}
    restart: unless-stopped
    depends_on:
        - "mlflow-test-db"
    networks:
      - db
      - mlflow
  mlflow-test-db:
    image: postgres:11.8
    env_file: .env.test.integration
    environment:
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
      NO_PROXY: ${NO_PROXY:-}
    restart: unless-stopped
    networks:
      - db
networks:
  mlflow:
    internal: true
  db:
    internal: true
